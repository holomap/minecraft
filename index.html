<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<script src="config.js"></script>
<link href="https://use.fontawesome.com/releases/v5.11.1/css/all.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="shortcut icon" href="images/favicon.ico" type="image/vnd.microsoft.icon">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145408095-1"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-145408095-1');
</script>
<title>ホロライブサーバ通常地図</title>
</head><body>
<main id="main"></main>
<script type="text/javascript">
(function(){

	// 最大範囲
	const mapinfo_base = {
		scale: 1,
		vw: 128*12 * 1,
		vh: 128*12 * 1,
		zx: 128*4.5 * 1,
		zy: 128*8.5 * 1,
	};
	// 以前の地図
	const mapinfo_old = {
		scale: 8,
		vw: 9216, // (128*8 + 64*2) * scale
		vh: 8192, // (128*7 + 64*2) * scale
		zx: 3072, // (64 + 128*2.5) * scale
		zy: 7168, // (64 + 128*6.5) * scale
	};

	const viewer = OpenSeadragon({
		id: "main",
		prefixUrl: "images/",
		showNavigator: true,
		imageSmoothingEnabled: false,
		maxZoomPixelRatio: 8,
		tileSources: {
			id: "base",
			type: "image",
			url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=",
		},
	});

	viewer.setupMapInfo(mapinfo_base);

	viewer.nav(); // ナビボタン
	viewer.bookmarkUrl(convertOldParams); // 座標URL
	viewer.stalkerImage(); // アニメーションポインター
	viewer.markerLink(4); // マーカーリンク
	viewer.saveImage(); // 画像ダウンロード
	viewer.printMode(); // 印刷モード

	loadMapLayers(viewer);

	loadMarkers(viewer); // マーカー情報

	function loadMapLayers(viewer) {
		// 詳細地図（レベル1）
		const mapinfo_1 = {
			scale: 1,
			vw: 128*8 * 1,
			vh: 128*8 * 1,
			zx: 128*2.5 * 1,
			zy: 128*6.5 * 1,
		};
		// 広範囲地図（レベル3）
		const mapinfo_3 = {
			scale: 1/4,
			vw: 128*12 * (1/4),
			vh: 128*12 * (1/4),
			zx: 128*4.5 * (1/4),
			zy: 128*8.5 * (1/4),
		};

		viewer.addTiledMap("original", mapinfo_1, {
			url: "tiles-original/",
			format: "png",
			tileSize: 256,
			overlap: 1,
			minLevel: 8,
			maxLevel: 10,
		});

		viewer.addSingleMap("3rd-scale", mapinfo_3, {
			url: "map/3rd_scale.png",
			index: 1, // under original
		});

		viewer.addSingleMap("aqua-line", mapinfo_1, {
			url: "map/aqua_line.png",
			visible: false,
			opacity: 0.75,
		});

		viewer.addSingleMap("nene-metro", mapinfo_1, {
			url: "map/nene_metro.png",
			visible: false,
			opacity: 0.75,
		});

		viewer.addSingleMap("rails", mapinfo_1, {
			url: "map/rails.png",
			visible: false,
		});

		viewer.addSingleMap("haachama-coaster", mapinfo_1, {
			url: "map/haachama_coaster.png",
			visible: false,
		});

		viewer.addSingleMap("tenkuu-aqua-line", mapinfo_1, {
			url: "map/tenkuu_aqua_line.png",
			visible: false,
		});

		viewer.addMapSwitcher([
			//["original", "生地図", true],
			//["aqua-line", "あくあライン（地下）", false],
			//["nene-metro", "ねねの地下通路", false],
			["metro", "地下通路（あくあライン、ねね）", false],
			["rails", "鉄道", false],
			["haachama-coaster", "はあちゃまコースター", false],
			["tenkuu-aqua-line", "天空あくあライン", false],
		], function(name, show) {
			if (name == "original") {
				viewer.showLayer("original", show);
				viewer.showLayer("3rd-scale", show);
			} else if (name == "metro") {
				viewer.showLayer("aqua-line", show);
				viewer.showLayer("nene-metro", show);
			} else {
				viewer.showLayer(name, show);
			}
			if (name == "rails" ||
				name == "haachama-coaster" ||
				name == "tenkuu-aqua-line" ||
				name == "aqua-line") {
				viewer.showMarkers(name, show);
			} else if (name == "metro") {
				viewer.showMarkers("aqua-line", show);
				viewer.showMarkers("nene-metro", show);
			} 
		});
	}

	function loadMarkers(viewer) {
		$.get("marker.csv", readMarkerCsv, 'text');
	
		function readMarkerCsv(data) {
			let markers = $.csv.toArrays(data);
			markers.shift(); // strip header
			// ignore commented-out rows
			markers = markers.filter(function(r){return !r[0].match(/^\/\//)});
			viewer.addMarkers(markers);
			viewer.showMarkers("normal", true);
		}
	}

	function convertOldParams(params) {
		const v1 = mapinfo_old;
		params.x = (params.x * v1.vw - v1.zx) / v1.scale;
		params.y = (params.y * v1.vw - v1.zy) / v1.scale; // not vh
	}

})();
</script>
</body>
</html>

